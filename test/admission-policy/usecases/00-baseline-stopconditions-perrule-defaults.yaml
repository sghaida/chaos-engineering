# ------------------------------------------------------------------------------
# EXPECT: ALLOW
# NOTE: Baseline: stopConditions per-rule mode with defaults (should pass S1..S6)
# ------------------------------------------------------------------------------
apiVersion: chaos.sghaida.io/v1alpha1
kind: FaultInjection
metadata:
  name: fi-stop-perrule
  namespace: demo
spec:
  blastRadius:
    durationSeconds: 60
    maxTrafficPercent: 10
    scope: namespace
  actions:
    meshFaults:
      -
        name: inbound-latency
        direction: INBOUND
        type: HTTP_LATENCY
        percent: 10
        http:
          virtualServiceRef:
            name: httpbin
          routes:
            -
              match:
                uriPrefix: /
          delay:
            fixedDelaySeconds: 2
  stopConditions:
    defaults:
      intervalSeconds: 10
      windowSeconds: 60
      consecutiveBreaches: 2
    rules:
      -
        name: error-rate
        promql: sum(rate(http_requests_total{code=~"5.."}[1m]))
        compare:
          op: GT
          threshold: 1.0
