# ------------------------------------------------------------------------------
# EXPECT: DENY
# EXPECT_MSG_CONTAINS: The FaultInjection "fi-inbound-latency" is invalid: spec.stopConditions.rules[0].structured.query.kind: Unsupported value: "irate": supported values: "rate", "count", "quantile"
# NOTE: Scenario: structured.query.kind invalid
# ------------------------------------------------------------------------------
apiVersion: chaos.sghaida.io/v1alpha1
kind: FaultInjection
metadata:
  name: fi-inbound-latency
  namespace: demo
spec:
  blastRadius:
    durationSeconds: 60
    maxTrafficPercent: 10
    scope: namespace
  actions:
    meshFaults:
      -
        name: inbound-latency
        direction: INBOUND
        type: HTTP_LATENCY
        percent: 10
        http:
          virtualServiceRef:
            name: httpbin
          routes:
            -
              match:
                uriPrefix: /
          delay:
            fixedDelaySeconds: 2
  stopConditions:
    overallBreachesCount: 3
    defaults:
      intervalSeconds: 10
      windowSeconds: 60
    rules:
      -
        name: p95-latency
        structured:
          metric:
            name: istio_request_duration_milliseconds_bucket
            type: histogram
          query:
            kind: irate
            quantile: 0.95
            aggregation: sum
          match:
            labels:
              destination_service: foo
            groupBy:
              - pod
        compare:
          op: GT
          threshold: 250.0
